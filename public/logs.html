<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Pantalla de Logs</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f6f8;
        padding: 20px;
        margin: 0;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
      }

      #filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
      }

      input {
        padding: 6px 12px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 0.9rem;
      }

      button {
        padding: 6px 15px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
      }

      button:hover {
        background: #0056b3;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        display: block;
        max-height: 70vh;
        overflow-y: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      thead {
        position: sticky;
        top: 0;
        background: #007bff;
        color: white;
        z-index: 1;
      }

      th,
      td {
        padding: 10px 8px;
        border-bottom: 1px solid #e0e0e0;
        text-align: left;
        font-size: 0.9rem;
      }

      tr.info {
        background-color: #e6f0ff;
      }
      tr.warning {
        background-color: #fff9e6;
      }
      tr.error {
        background-color: #ffe6e6;
      }

      tr:hover {
        background-color: #d1ebff;
      }

      table tbody {
        display: block;
      }

      table thead,
      table tbody tr {
        display: table;
        width: 100%;
        table-layout: fixed;
      }
    </style>
  </head>
  <body>
    <h1>Visor de Logs</h1>

    <div id="filters">
      <input type="text" id="filter-tienda" placeholder="Filtrar por tienda" />
      <input type="text" id="filter-fecha" placeholder="Filtrar por fecha (dd-mm-yyyy)" />
      <input type="text" id="filter-turno" placeholder="Filtrar por turno" />
      <input type="text" id="filter-tipo" placeholder="Filtrar por tipo" />
      <input type="text" id="filter-codigo" placeholder="Filtrar por código" />
      <input type="text" id="filter-mensaje" placeholder="Filtrar por mensaje" />
      <input type="text" id="filter-origen" placeholder="Filtrar por origen" />
      <button onclick="loadLogs()">Actualizar</button>
    </div>

    <table id="logs-table">
      <thead>
        <tr>
          <th>Tienda</th>
          <th>Fecha ventas</th>
          <th>Turno</th>
          <th>Tipo</th>
          <th>Código</th>
          <th>Mensaje</th>
          <th>Origen</th>
          <th>Sincronización</th>
          <th>Company</th>
          <th>Entorno</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      // Normaliza cualquier fecha a dd-mm-yyyy
      function formatFecha(fecha) {
        if (!fecha) return '';
        if (/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
          const [yyyy, mm, dd] = fecha.split('-');
          return `${dd}-${mm}-${yyyy}`;
        } else if (/^\d{2}-\d{2}-\d{4}$/.test(fecha)) {
          return fecha;
        } else {
          return fecha;
        }
      }

      async function loadLogs() {
        try {
          const response = await fetch('/helpers');
          const logs = await response.json();

          const tiendaFilter = (document.getElementById('filter-tienda').value || '').toLowerCase();
          const fechaFilter = (document.getElementById('filter-fecha').value || '').toLowerCase();
          const turnoFilter = (document.getElementById('filter-turno').value || '').toLowerCase();
          const tipoFilter = (document.getElementById('filter-tipo').value || '').toLowerCase();
          const codigoFilter = (document.getElementById('filter-codigo').value || '').toLowerCase();
          const mensajeFilter = (document.getElementById('filter-mensaje').value || '').toLowerCase();
          const origenFilter = (document.getElementById('filter-origen').value || '').toLowerCase();

          // Filtrado seguro para strings y números
          let filtered = logs.filter((log) => {
            return (
              (!tiendaFilter ||
                String(log.tienda || '')
                  .toLowerCase()
                  .includes(tiendaFilter)) &&
              (!fechaFilter ||
                formatFecha(String(log.fecha || ''))
                  .toLowerCase()
                  .includes(fechaFilter)) &&
              (!turnoFilter ||
                String(log.turno || '')
                  .toLowerCase()
                  .includes(turnoFilter)) &&
              (!tipoFilter ||
                String(log.tipo || '')
                  .toLowerCase()
                  .includes(tipoFilter)) &&
              (!codigoFilter ||
                String(log.codigo || '')
                  .toLowerCase()
                  .includes(codigoFilter)) &&
              (!mensajeFilter ||
                String(log.mensaje || '')
                  .toLowerCase()
                  .includes(mensajeFilter)) &&
              (!origenFilter ||
                String(log.origen || '')
                  .toLowerCase()
                  .includes(origenFilter))
            );
          });

          // Orden descendente por fecha + timestamp
          filtered.sort((a, b) => {
            const parseDate = (fechaStr, timestamp) => {
              const f = formatFecha(fechaStr); // dd-mm-yyyy
              const [dd, mm, yyyy] = f.split('-');
              return new Date(`${yyyy}-${mm}-${dd} ${timestamp || ''}`);
            };
            return parseDate(b.fecha, b.timestamp) - parseDate(a.fecha, a.timestamp);
          });

          const tbody = document.querySelector('#logs-table tbody');
          tbody.innerHTML = '';
          const fragment = document.createDocumentFragment();

          filtered.forEach((log) => {
            const tr = document.createElement('tr');
            tr.className = String(log.tipo || '').toLowerCase();
            tr.innerHTML = `
              <td>${log.tienda || ''}</td>
              <td>${formatFecha(log.fecha) || ''}</td>
              <td>${log.turno || ''}</td>
              <td>${log.tipo || ''}</td>
              <td>${log.codigo || ''}</td>
              <td>${log.mensaje || ''}</td>
              <td>${log.origen || ''}</td>
              <td>${log.timestamp || ''}</td>
              <td>${log.companyID || ''}</td>
              <td>${log.entorno || ''}</td>
            `;
            fragment.appendChild(tr);
          });

          tbody.appendChild(fragment);
        } catch (err) {
          console.error('Error cargando logs:', err);
        }
      }

      loadLogs();
    </script>
  </body>
</html>
